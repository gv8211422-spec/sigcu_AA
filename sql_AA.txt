-- =================================================================
-- SIGCU2 - Versión de Base de Datos: FINAL (Definitiva)
-- =================================================================

CREATE DATABASE sigcu2 CHARACTER SET utf8mb4 COLLATE utf8mb4_spanish_ci;
USE sigcu2;

-- Tabla USUARIOS simplificada
CREATE TABLE usuarios (
    id_usuario INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    apellido_paterno VARCHAR(100) NOT NULL,
    apellido_materno VARCHAR(100),
    email VARCHAR(150) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    rol ENUM('administrador', 'docente', 'alumno', 'administrativo') NOT NULL,
    matricula VARCHAR(50) UNIQUE,
    telefono VARCHAR(20),
    estado_cuenta ENUM('activo', 'inactivo', 'pendiente') DEFAULT 'pendiente',
    fecha_registro DATETIME DEFAULT CURRENT_TIMESTAMP,
    ultimo_acceso DATETIME,
    token_recuperacion VARCHAR(255),
    token_expiracion DATETIME
);

-- Tabla de materias
CREATE TABLE materias (
    id_materia INT AUTO_INCREMENT PRIMARY KEY,
    nombre_materia VARCHAR(100) NOT NULL,
    clave_materia VARCHAR(20) NOT NULL UNIQUE,
    departamento VARCHAR(100) NOT NULL,
    carrera VARCHAR(100) NOT NULL,
    creditos INT NOT NULL,
    porcentaje_examenes DECIMAL(5,2) DEFAULT 70.00,
    porcentaje_actividades DECIMAL(5,2) DEFAULT 30.00
);

-- Tabla de grupos
CREATE TABLE grupos (
    id_grupo INT AUTO_INCREMENT PRIMARY KEY,
    nombre_grupo VARCHAR(20) NOT NULL,
    id_materia INT NOT NULL,
    semestre VARCHAR(20) NOT NULL,
    cupo_maximo INT DEFAULT 30,
    FOREIGN KEY (id_materia) REFERENCES materias(id_materia)
);

-- Tabla de inscripciones
CREATE TABLE inscripciones (
    id_inscripcion INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    id_grupo INT NOT NULL,
    periodo_escolar VARCHAR(20) NOT NULL,
    estado ENUM('activa', 'cancelada', 'baja') DEFAULT 'activa',
    UNIQUE KEY unique_inscripcion (id_alumno, id_grupo, periodo_escolar),
    FOREIGN KEY (id_alumno) REFERENCES usuarios(id_usuario),
    FOREIGN KEY (id_grupo) REFERENCES grupos(id_grupo)
);

-- Tabla CALIFICACIONES con resumen de asistencias
CREATE TABLE calificaciones (
    id_calificacion INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    id_materia INT NOT NULL,
    periodo_escolar VARCHAR(20) NOT NULL,
    calificacion_final DECIMAL(5,2) DEFAULT 0.00,
    estado_materia ENUM('inscrito', 'cursando', 'aprobada', 'reprobada', 'recursando') DEFAULT 'inscrito',
    total_clases_periodo INT DEFAULT 0,
    total_asistencias_periodo INT DEFAULT 0,
    UNIQUE KEY unique_calificacion (id_alumno, id_materia, periodo_escolar),
    FOREIGN KEY (id_alumno) REFERENCES usuarios(id_usuario),
    FOREIGN KEY (id_materia) REFERENCES materias(id_materia)
);

-- Tabla de EXÁMENES
CREATE TABLE examenes (
    id_examen INT AUTO_INCREMENT PRIMARY KEY,
    id_calificacion INT NOT NULL,
    tipo_evaluacion ENUM('primer_parcial', 'segundo_parcial', 'tercer_parcial', 'examen_final', 'extraordinario', 'titulo_suficiencia') NOT NULL,
    calificacion DECIMAL(5,2) NOT NULL,
    id_docente_registro INT NOT NULL,
    fecha_registro DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_calificacion) REFERENCES calificaciones(id_calificacion) ON DELETE CASCADE,
    FOREIGN KEY (id_docente_registro) REFERENCES usuarios(id_usuario)
);

-- Tabla de actividades académicas
CREATE TABLE actividades_academicas (
    id_actividad INT AUTO_INCREMENT PRIMARY KEY,
    id_grupo INT NOT NULL,
    id_docente INT NOT NULL,
    titulo VARCHAR(150) NOT NULL,
    descripcion TEXT,
    tipo_actividad ENUM('tarea', 'practica', 'proyecto', 'exposicion') NOT NULL,
    fecha_entrega DATETIME,
    valor_maximo DECIMAL(5,2) NOT NULL,
    archivo_adjunto VARCHAR(255),
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    estado ENUM('activo', 'cancelado') DEFAULT 'activo',
    FOREIGN KEY (id_grupo) REFERENCES grupos(id_grupo),
    FOREIGN KEY (id_docente) REFERENCES usuarios(id_usuario)
);

-- Tabla de calificaciones de actividades
CREATE TABLE calificaciones_actividades (
    id_calificacion_actividad INT AUTO_INCREMENT PRIMARY KEY,
    id_actividad INT NOT NULL,
    id_alumno INT NOT NULL,
    calificacion_obtenida DECIMAL(5,2) NOT NULL,
    archivo_entregado VARCHAR(255),
    comentarios_docente TEXT,
    fecha_calificacion DATETIME,
    UNIQUE KEY unique_calificacion_actividad (id_actividad, id_alumno),
    FOREIGN KEY (id_actividad) REFERENCES actividades_academicas(id_actividad) ON DELETE CASCADE,
    FOREIGN KEY (id_alumno) REFERENCES usuarios(id_usuario)
);

-- Tabla HORARIOS de Lunes a Viernes
CREATE TABLE horarios (
    id_horario INT AUTO_INCREMENT PRIMARY KEY,
    id_grupo INT NOT NULL,
    dia_semana ENUM('lunes', 'martes', 'miércoles', 'jueves', 'viernes') NOT NULL,
    hora_inicio TIME NOT NULL,
    hora_fin TIME NOT NULL,
    aula VARCHAR(20),
    FOREIGN KEY (id_grupo) REFERENCES grupos(id_grupo)
);

-- Tabla de mensajes
CREATE TABLE mensajes (
    id_mensaje INT AUTO_INCREMENT PRIMARY KEY,
    id_remitente INT NOT NULL,
    id_destinatario INT,
    asunto VARCHAR(150) NOT NULL,
    mensaje TEXT NOT NULL,
    fecha_envio DATETIME DEFAULT CURRENT_TIMESTAMP,
    leido ENUM('si', 'no') DEFAULT 'no',
    estado ENUM('activo', 'eliminado') DEFAULT 'activo',
    FOREIGN KEY (id_remitente) REFERENCES usuarios(id_usuario),
    FOREIGN KEY (id_destinatario) REFERENCES usuarios(id_usuario)
);

-- Tabla de solicitudes de documentos
CREATE TABLE solicitudes_documentos (
    id_solicitud INT AUTO_INCREMENT PRIMARY KEY,
    id_alumno INT NOT NULL,
    tipo_documento ENUM('historial_academico', 'constancia_estudios', 'ficha_extraordinario', 'ficha_titulo_suficiencia', 'baja_parcial', 'baja_definitiva') NOT NULL,
    estado_solicitud ENUM('pendiente', 'procesando', 'aprobada', 'rechazada') DEFAULT 'pendiente',
    fecha_solicitud DATETIME DEFAULT CURRENT_TIMESTAMP,
    comentarios TEXT,
    FOREIGN KEY (id_alumno) REFERENCES usuarios(id_usuario)
);

-- =================================================================
-- MODIFICACIÓN 11: Tabla HISTORIAL_SISTEMA sin ip_address
-- =================================================================
CREATE TABLE historial_sistema (
    id_historial INT AUTO_INCREMENT PRIMARY KEY,
    id_usuario INT NOT NULL,
    accion VARCHAR(100) NOT NULL,
    descripcion TEXT,
    fecha_accion DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (id_usuario) REFERENCES usuarios(id_usuario)
);

-- =================================================================
-- TRIGGER para llenado automático de CALIFICACIONES
-- =================================================================
DELIMITER //
CREATE TRIGGER after_inscripcion_create_calificacion
AFTER INSERT ON inscripciones
FOR EACH ROW
BEGIN
    INSERT IGNORE INTO calificaciones (id_alumno, id_materia, periodo_escolar)
    SELECT NEW.id_alumno, g.id_materia, NEW.periodo_escolar
    FROM grupos g
    WHERE g.id_grupo = NEW.id_grupo;
END//
DELIMITER ;
